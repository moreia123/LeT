<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página do Usuário</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Inclua a API do Google Maps com a biblioteca Places -->
    <script src="https://maps.googleapis.com/maps/api/js?key=SUA_CHAVE_DA_API&libraries=places"></script>
</head>
<body class="user-page">
    <div class="container">
        <h2>Bem-vindo, <span id="nomeUsuario"></span>!</h2>
        <p>Esta é a página do usuário.</p>

        <h3>Calcular Custo de Entrega</h3>
        <form id="formEntrega">
            <input type="text" id="origem" placeholder="Endereço de Origem" required>
            <input type="text" id="destino" placeholder="Endereço de Destino" required>
            <button type="submit">Calcular Custo</button>
        </form>

        <div id="resultadoEntrega">
            <!-- Resultados serão exibidos aqui -->
        </div>

        <h3>Seus Pedidos</h3>
        <table id="tabelaPedidos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Descrição</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <!-- Pedidos serão inseridos aqui via JavaScript -->
            </tbody>
        </table>

        <h3>Adicionar Novo Pedido</h3>
        <form id="formPedido">
            <input type="text" id="descricao" placeholder="Descrição do Pedido" required>
            <button type="submit">Adicionar Pedido</button>
        </form>

        <a href="index.html">Voltar para a Página Inicial</a>
    </div>

    <script>
        // Recupera o nome do usuário
        const nome = localStorage.getItem('usuarioNome');
        document.getElementById('nomeUsuario').textContent = nome;

        // Função para carregar pedidos
        function carregarPedidos() {
            const pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
            const tabela = document.getElementById('tabelaPedidos').getElementsByTagName('tbody')[0];
            tabela.innerHTML = ''; // Limpa a tabela antes de carregar os pedidos

            pedidos.forEach((pedido, index) => {
                const row = tabela.insertRow();
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = pedido.descricao;
                row.insertCell().textContent = pedido.status;
            });
        }

        // Função para adicionar pedido
        document.getElementById('formPedido').addEventListener('submit', function(event) {
            event.preventDefault();
            const descricao = document.getElementById('descricao').value;

            const pedido = {
                descricao: descricao,
                status: 'Pendente'
            };

            const pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
            pedidos.push(pedido);
            localStorage.setItem('pedidos', JSON.stringify(pedidos));

            alert('Pedido adicionado com sucesso!');
            carregarPedidos(); // Atualiza a lista de pedidos
            document.getElementById('descricao').value = ''; // Limpa o campo de descrição
        });

        // Função para calcular a distância e o custo
        function calcularDistanciaECusto(origem, destino) {
            const service = new google.maps.DistanceMatrixService();

            service.getDistanceMatrix({
                origins: [origem],
                destinations: [destino],
                travelMode: 'DRIVING',
                unitSystem: google.maps.UnitSystem.METRIC,
            }, (response, status) => {
                if (status === 'OK') {
                    const distancia = response.rows[0].elements[0].distance.value / 1000; // Distância em KM
                    const custo = calcularCusto(distancia);
                    exibirResultado(distancia, custo);
                } else {
                    alert('Erro ao calcular a distância. Verifique os endereços.');
                }
            });
        }

        // Função para calcular o custo com base na distância
        function calcularCusto(distancia) {
            const custoBase = 10; // R$ 10,00 para os primeiros 4 KM
            const kmAdicional = Math.max(0, distancia - 4); // KM adicionais após os 4 KM
            return custoBase + kmAdicional * 1; // R$ 1,00 por KM adicional
        }

        // Função para exibir o resultado
        function exibirResultado(distancia, custo) {
            const resultadoDiv = document.getElementById('resultadoEntrega');
            resultadoDiv.innerHTML = `
                <p>Distância: ${distancia.toFixed(2)} KM</p>
                <p>Custo da Entrega: R$ ${custo.toFixed(2)}</p>
            `;
        }

        // Evento de envio do formulário de entrega
        document.getElementById('formEntrega').addEventListener('submit', function(event) {
            event.preventDefault();
            const origem = document.getElementById('origem').value;
            const destino = document.getElementById('destino').value;
            calcularDistanciaECusto(origem, destino);
        });

        // Inicializa o autocompletar para os campos de endereço
        function initAutocomplete() {
            const origemInput = document.getElementById('origem');
            const destinoInput = document.getElementById('destino');

            const autocompleteOrigem = new google.maps.places.Autocomplete(origemInput, {
                types: ['geocode'], // Restringe a sugestões de endereços físicos
            });

            const autocompleteDestino = new google.maps.places.Autocomplete(destinoInput, {
                types: ['geocode'], // Restringe a sugestões de endereços físicos
            });
        }

        // Carrega os pedidos ao abrir a página
        carregarPedidos();

        // Inicializa o autocompletar quando a API do Google Maps estiver pronta
        google.maps.event.addDomListener(window, 'load', initAutocomplete);
    </script>
</body>
</html>