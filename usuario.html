<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Página do Usuário</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase e Google Maps -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHVoDPPaxYjkjlVfWd5HFYZiORGbR8h0Q",
            authDomain: "let-log-5faef.firebaseapp.com",
            projectId: "let-log-5faef",
            storageBucket: "let-log-5faef.firebasestorage.app",
            messagingSenderId: "818297522117",
            appId: "1:818297522117:web:cb311458fb531b273f6dac",
            measurementId: "G-6XVWCM8MNT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Verifica se o usuário está logado
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login-usuario.html';
            } else {
                document.getElementById('nomeUsuario').textContent = user.email; // Exibe o e-mail do usuário
            }
        });

        // Função para carregar pedidos
        async function carregarPedidos() {
            const tabela = document.getElementById('tabelaPedidos').getElementsByTagName('tbody')[0];
            tabela.innerHTML = '';

            const q = query(collection(db, 'pedidos'), where('userId', '==', auth.currentUser.uid));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc, index) => {
                const pedido = doc.data();
                const row = tabela.insertRow();
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = pedido.descricao;
                row.insertCell().textContent = `${pedido.ruaColeta}, ${pedido.numeroColeta} - ${pedido.bairroColeta}`;
                row.insertCell().textContent = `${pedido.ruaEntrega}, ${pedido.numeroEntrega} - ${pedido.bairroEntrega}`;
                row.insertCell().textContent = `R$ ${pedido.valor.toFixed(2)}`;
                row.insertCell().textContent = pedido.status; // Exibe o status do pedido
            });
        }

        // Função para calcular o valor da entrega
        function calcularValorEntrega(distancia) {
            const valorBase = 10.00; // Valor inicial
            const distanciaKm = parseFloat(distancia);
            if (distanciaKm <= 4) {
                return valorBase;
            } else {
                return valorBase + (distanciaKm - 4) * 2.00; // R$ 2,00 por km adicional
            }
        }

        // Função para autocompletar endereço
        function initAutocomplete() {
            const inputColeta = document.getElementById('ruaColetaPedido');
            const inputEntrega = document.getElementById('ruaEntregaPedido');

            const autocompleteColeta = new google.maps.places.Autocomplete(inputColeta);
            const autocompleteEntrega = new google.maps.places.Autocomplete(inputEntrega);

            // Preenche os campos automaticamente ao selecionar um endereço
            autocompleteColeta.addListener('place_changed', () => {
                const place = autocompleteColeta.getPlace();
                document.getElementById('numeroColetaPedido').value = ''; // Limpa o número
                document.getElementById('bairroColetaPedido').value = ''; // Limpa o bairro
                place.address_components.forEach(component => {
                    if (component.types.includes('street_number')) {
                        document.getElementById('numeroColetaPedido').value = component.long_name;
                    }
                    if (component.types.includes('sublocality') || component.types.includes('neighborhood')) {
                        document.getElementById('bairroColetaPedido').value = component.long_name;
                    }
                });
            });

            autocompleteEntrega.addListener('place_changed', () => {
                const place = autocompleteEntrega.getPlace();
                document.getElementById('numeroEntregaPedido').value = ''; // Limpa o número
                document.getElementById('bairroEntregaPedido').value = ''; // Limpa o bairro
                place.address_components.forEach(component => {
                    if (component.types.includes('street_number')) {
                        document.getElementById('numeroEntregaPedido').value = component.long_name;
                    }
                    if (component.types.includes('sublocality') || component.types.includes('neighborhood')) {
                        document.getElementById('bairroEntregaPedido').value = component.long_name;
                    }
                });
            });
        }

        // Função para adicionar pedido
        document.getElementById('formPedido').addEventListener('submit', async function(event) {
            event.preventDefault();
            const descricao = document.getElementById('descricao').value;
            const ruaColeta = document.getElementById('ruaColetaPedido').value;
            const numeroColeta = document.getElementById('numeroColetaPedido').value;
            const bairroColeta = document.getElementById('bairroColetaPedido').value;
            const ruaEntrega = document.getElementById('ruaEntregaPedido').value;
            const numeroEntrega = document.getElementById('numeroEntregaPedido').value;
            const bairroEntrega = document.getElementById('bairroEntregaPedido').value;

            // Calcula a distância usando a API do Google Maps Distance Matrix
            const distancia = await calcularDistancia(`${ruaColeta} ${numeroColeta}, ${bairroColeta}`, `${ruaEntrega} ${numeroEntrega}, ${bairroEntrega}`);
            const valor = calcularValorEntrega(distancia);

            const pedido = {
                descricao: descricao,
                ruaColeta: ruaColeta,
                numeroColeta: numeroColeta,
                bairroColeta: bairroColeta,
                ruaEntrega: ruaEntrega,
                numeroEntrega: numeroEntrega,
                bairroEntrega: bairroEntrega,
                valor: valor,
                status: 'Pendente',
                userId: auth.currentUser.uid
            };

            await addDoc(collection(db, 'pedidos'), pedido);
            alert('Pedido adicionado com sucesso!');
            carregarPedidos(); // Recarrega a lista de pedidos
            document.getElementById('formPedido').reset(); // Limpa o formulário
        });

        // Função para calcular a distância
        async function calcularDistancia(origem, destino) {
            const service = new google.maps.DistanceMatrixService();
            return new Promise((resolve, reject) => {
                service.getDistanceMatrix(
                    {
                        origins: [origem],
                        destinations: [destino],
                        travelMode: 'DRIVING',
                        unitSystem: google.maps.UnitSystem.METRIC,
                    },
                    (response, status) => {
                        if (status === 'OK') {
                            const distancia = response.rows[0].elements[0].distance.value / 1000; // Distância em km
                            resolve(distancia);
                        } else {
                            reject('Erro ao calcular distância: ' + status);
                        }
                    }
                );
            });
        }

        // Carrega os pedidos ao abrir a página
        carregarPedidos();

        // Inicializa o autocompletar do Google Maps
        window.initAutocomplete = initAutocomplete;
    </script>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBLrhgPGGZIQLgUgoU-cuXj0_QskZv-4bk&libraries=places&callback=initAutocomplete" async defer></script>
</head>
<body class="user-page">
    <div class="container">
        <!-- Imagem no topo -->
        <div class="logo-container">
            <img src="Logo.jpeg" alt="Logo" class="logo">
        </div>

        <h2>Bem-vindo, <span id="nomeUsuario"></span>!</h2>
        <p>Esta é a página do usuário.</p>

        <h3>Adicionar Novo Pedido</h3>
        <form id="formPedido">
            <input type="text" id="descricao" placeholder="Descrição do Pedido" required>
            <h4>Endereço de Coleta</h4>
            <input type="text" id="ruaColetaPedido" placeholder="Rua" required>
            <input type="text" id="numeroColetaPedido" placeholder="Número" required>
            <input type="text" id="bairroColetaPedido" placeholder="Bairro" required>

            <h4>Endereço de Entrega</h4>
            <input type="text" id="ruaEntregaPedido" placeholder="Rua" required>
            <input type="text" id="numeroEntregaPedido" placeholder="Número" required>
            <input type="text" id="bairroEntregaPedido" placeholder="Bairro" required>

            <button type="submit">Adicionar Pedido</button>
        </form>

        <h3>Seus Pedidos</h3>
        <table id="tabelaPedidos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Descrição</th>
                    <th>Local de Coleta</th>
                    <th>Local de Entrega</th>
                    <th>Valor</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <!-- Pedidos serão inseridos aqui via JavaScript -->
            </tbody>
        </table>

        <a href="index.html">Voltar para a Página Inicial</a>
    </div>
</body>
</html>
